# åŸå¸‚ä½ç©ºç»¼åˆæ²»ç†ä¸åº”æ€¥æŒ‡æŒ¥å¹³å°
# ç®¡ç†å‘˜æ“ä½œæ‰‹å†Œï¼ˆV2.0ï¼‰

- æ–‡æ¡£ç‰ˆæœ¬ï¼šV2.0
- é€‚ç”¨èŒƒå›´ï¼šå¹³å°ç®¡ç†å‘˜ã€ä¸šåŠ¡ç®¡ç†å‘˜ã€å®‰å…¨å®¡è®¡ç®¡ç†å‘˜
- æ›´æ–°æ—¥æœŸï¼š2026-02-21

---

## 1. ç®¡ç†å‘˜èŒè´£

ç®¡ç†å‘˜ä¸»è¦è´Ÿè´£ï¼š

1. ç§Ÿæˆ·ã€ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç®¡ç†
2. ä¸šåŠ¡æ¨¡æ¿ä¸åŸºç¡€é…ç½®ç»´æŠ¤
3. åº”æ€¥ä¸å·¡æŸ¥ä¸šåŠ¡è¿‡ç¨‹ç›‘ç£
4. å®¡æ‰¹ä¸å®¡è®¡ç•™ç—•ç®¡ç†
5. æŠ¥è¡¨ç»Ÿè®¡ä¸å¯¼å‡ºç®¡ç†

---

## 2. ç®¡ç†å…¥å£ä¸å‡†å¤‡

### 2.1 ç®¡ç†å…¥å£

- OpenAPIï¼š`/docs`
- æ ¸å¿ƒ UI é¡µé¢ï¼š
  - `/ui/inspection`
  - `/ui/defects`
  - `/ui/emergency`
  - `/ui/command-center`

### 2.2 å‰ç½®å‡†å¤‡

1. ç³»ç»ŸæœåŠ¡å¯ç”¨ï¼ˆ`/healthz`ã€`/readyz` è¿”å› 200ï¼‰
2. å·²åˆ›å»ºç§Ÿæˆ·å¹¶å®Œæˆç®¡ç†å‘˜å¼•å¯¼
3. ç®¡ç†å‘˜è´¦æˆ·å…·å¤‡ `*` æˆ–å¯¹åº”ç®¡ç†æƒé™

---

## 3. è´¦æˆ·ä¸æƒé™ç®¡ç†

è¯´æ˜ï¼šç³»ç»Ÿé‡‡ç”¨ç§Ÿæˆ·éš”ç¦» + RBACï¼Œæ‰€æœ‰ä¸šåŠ¡æ•°æ®å‡å½’å± `tenant_id`ã€‚

### 3.1 æ–°å»ºç§Ÿæˆ·

æ¥å£ï¼š`POST /api/identity/tenants`

ç¤ºä¾‹ï¼š

```bash
curl -X POST http://localhost:8000/api/identity/tenants \
  -H "Content-Type: application/json" \
  -d '{"name":"city-a"}'
```

### 3.2 åˆå§‹åŒ–ç§Ÿæˆ·ç®¡ç†å‘˜

æ¥å£ï¼š`POST /api/identity/bootstrap-admin`

```bash
curl -X POST http://localhost:8000/api/identity/bootstrap-admin \
  -H "Content-Type: application/json" \
  -d '{"tenant_id":"<tenant_id>","username":"admin","password":"admin-pass"}'
```

### 3.3 ç™»å½•è·å–ä»¤ç‰Œ

æ¥å£ï¼š`POST /api/identity/dev-login`

```bash
curl -X POST http://localhost:8000/api/identity/dev-login \
  -H "Content-Type: application/json" \
  -d '{"tenant_id":"<tenant_id>","username":"admin","password":"admin-pass"}'
```

### 3.4 ç”¨æˆ·ä¸è§’è‰²ç®¡ç†

å¸¸ç”¨æ¥å£ï¼š

- ç”¨æˆ·ï¼š`/api/identity/users`
- è§’è‰²ï¼š`/api/identity/roles`
- æƒé™ï¼š`/api/identity/permissions`
- ç”¨æˆ·ç»‘å®šè§’è‰²ï¼š`POST /api/identity/users/{user_id}/roles/{role_id}`
- è§’è‰²ç»‘å®šæƒé™ï¼š`POST /api/identity/roles/{role_id}/permissions/{permission_id}`

### 3.5 æ¨èè§’è‰²åˆ’åˆ†

1. `platform_admin`ï¼šå…¨æƒé™ï¼ˆå¹³å°è¿ç»´/åº”æ€¥æ€»æŒ‡æŒ¥ï¼‰
2. `inspection_manager`ï¼šå·¡æŸ¥ä¸é—®é¢˜é—­ç¯ç®¡ç†
3. `emergency_operator`ï¼šåº”æ€¥äº‹ä»¶å¤„ç½®
4. `auditor`ï¼šå®¡æ‰¹å’Œå®¡è®¡æŸ¥è¯¢å¯¼å‡º
5. `report_viewer`ï¼šæŠ¥è¡¨æŸ¥çœ‹ä¸å¯¼å‡º

---

## 4. å·¡æŸ¥ä¸šåŠ¡ç®¡ç†

### 4.1 å·¡æŸ¥æ¨¡æ¿ç®¡ç†

ç®¡ç†å‘˜ç»´æŠ¤æ¨¡æ¿åŠæ£€æŸ¥é¡¹ï¼Œå»ºè®®æ¯å­£åº¦å¤å®¡ã€‚

å…³é”®æ¥å£ï¼š

- `GET/POST /api/inspection/templates`
- `POST /api/inspection/templates/{id}/items`
- `GET /api/inspection/templates/{id}/items`

### 4.2 å·¡æŸ¥ä»»åŠ¡ç›‘ç®¡

- ä»»åŠ¡åˆ›å»ºï¼š`POST /api/inspection/tasks`
- ä»»åŠ¡æŸ¥è¯¢ï¼š`GET /api/inspection/tasks`
- ä»»åŠ¡è¯¦æƒ…ï¼š`GET /api/inspection/tasks/{id}`
- UIï¼š`/ui/inspection?token=<token>`

### 4.3 å·¡æŸ¥ç»“æœä¸å¯¼å‡ºç›‘ç®¡

- è§‚æµ‹ç‚¹å†™å…¥ï¼š`POST /api/inspection/tasks/{task_id}/observations`
- è§‚æµ‹ç‚¹æŸ¥è¯¢ï¼š`GET /api/inspection/tasks/{task_id}/observations`
- å¯¼å‡ºï¼š`POST /api/inspection/tasks/{task_id}/export?format=html`

å»ºè®®ï¼š

1. æ¯å‘¨æŠ½æ£€å¯¼å‡ºæŠ¥å‘Šè´¨é‡ä¸å­—æ®µå®Œæ•´æ€§ã€‚
2. å¯¹é«˜ä¸¥é‡åº¦é—®é¢˜è®¾ç½®ä¸“äººè·Ÿè¸ªé—­ç¯ã€‚

---

## 5. é—®é¢˜é—­ç¯ç®¡ç†

### 5.1 é—®é¢˜å•ç”Ÿæˆä¸æŒ‡æ´¾

- ç”Ÿæˆé—®é¢˜å•ï¼š`POST /api/defects/from-observation/{observation_id}`
- æŒ‡æ´¾ï¼š`POST /api/defects/{id}/assign`

### 5.2 çŠ¶æ€æµè½¬è§„èŒƒ

ç³»ç»Ÿå†…ç½®æµç¨‹ï¼š

`OPEN -> ASSIGNED -> IN_PROGRESS -> FIXED -> VERIFIED -> CLOSED`

æ¥å£ï¼š

- `POST /api/defects/{id}/status`

### 5.3 é—­ç¯ç»Ÿè®¡

- ç»Ÿè®¡æ¥å£ï¼š`GET /api/defects/stats`
- ç®¡ç†é¡µé¢ï¼š`/ui/defects?token=<token>`

ç®¡ç†å‘˜è¦æ±‚ï¼š

1. æ¯æ—¥æ£€æŸ¥é—­ç¯ç‡å’Œç§¯å‹é‡ã€‚
2. å¯¹è¶…æœŸå•æ®æ‰§è¡Œå‚¬åŠå’Œå¤æ ¸ã€‚

---

## 6. åº”æ€¥ç®¡ç†

### 6.1 åº”æ€¥äº‹ä»¶åˆ›å»º

- `POST /api/incidents`

### 6.2 ä¸€é”®ä»»åŠ¡ç”Ÿæˆ

- `POST /api/incidents/{id}/create-task`

é¡µé¢ï¼š

- `/ui/emergency?token=<token>`

ç®¡ç†å‘˜è¦æ±‚ï¼š

1. åº”æ€¥äº‹ä»¶éœ€è®°å½•ç­‰çº§ã€ä½ç½®ã€è´£ä»»äººã€‚
2. äº‹ä»¶å¤„ç½®ååº”æ›´æ–°çŠ¶æ€å¹¶çº³å…¥å¤ç›˜ã€‚

---

## 7. æŒ‡æŒ¥ä¸­å¿ƒç®¡ç†

é¡µé¢ï¼š`/ui/command-center?token=<token>`

æ•°æ®æ¥å£ï¼š

- `GET /api/dashboard/stats`
- `WS /ws/dashboard?token=<token>`

ç®¡ç†å‘˜é‡ç‚¹å…³æ³¨ï¼š

1. åœ¨çº¿è®¾å¤‡æ•°é‡å¼‚å¸¸æ³¢åŠ¨
2. å‘Šè­¦çªå¢
3. é«˜ä¸¥é‡åº¦è§‚æµ‹ç‚¹åˆ†å¸ƒ

---

## 8. å®¡æ‰¹ä¸å®¡è®¡ç®¡ç†

### 8.1 å®¡æ‰¹è®°å½•

- æ–°å¢å®¡æ‰¹ï¼š`POST /api/approvals`
- æŸ¥è¯¢å®¡æ‰¹ï¼š`GET /api/approvals`

### 8.2 å®¡è®¡å¯¼å‡º

- `GET /api/approvals/audit-export`
- æ–‡ä»¶ç›®å½•ï¼š`logs/exports/`

å»ºè®®ï¼š

1. æ¯å‘¨å½’æ¡£å®¡è®¡å¯¼å‡ºæ–‡ä»¶
2. å¯¹å…³é”®åŠ¨ä½œè¿›è¡ŒæŠ½æŸ¥ï¼ˆä»»åŠ¡åˆ›å»ºã€åº”æ€¥ã€å®¡æ‰¹ã€å¯¼å‡ºï¼‰

---

## 9. æŠ¥è¡¨ç®¡ç†

æ¥å£ï¼š

- `GET /api/reporting/overview`
- `GET /api/reporting/closure-rate`
- `GET /api/reporting/device-utilization`
- `POST /api/reporting/export`

ç®¡ç†å‘˜å»ºè®®ï¼š

1. æœˆåº¦æ±‡æ€»ï¼šå·¡æŸ¥é‡ã€é—®é¢˜é‡ã€é—­ç¯ç‡
2. å­£åº¦æ±‡æ€»ï¼šè®¾å¤‡åˆ©ç”¨ç‡ã€åº”æ€¥å“åº”æƒ…å†µ

---

## 10. ç®¡ç†å‘˜æ—¥å¸¸å·¡æ£€æ¸…å•

æ¯æ—¥ï¼š

1. æ£€æŸ¥ `healthz/readyz`
2. æ£€æŸ¥å‰ä¸€æ—¥é—®é¢˜é—­ç¯ç‡
3. æ£€æŸ¥åº”æ€¥äº‹ä»¶æ˜¯å¦æœ‰æœªå¤„ç†é¡¹

æ¯å‘¨ï¼š

1. å¯¼å‡ºå®¡è®¡æ—¥å¿—å¹¶å½’æ¡£
2. å¤æ ¸è§’è‰²æƒé™æœ€å°åŒ–åŸåˆ™
3. æŠ½æŸ¥å·¡æŸ¥å¯¼å‡ºæŠ¥å‘Š

æ¯æœˆï¼š

1. å¯¼å‡ºæŠ¥è¡¨å¹¶å½¢æˆç®¡ç†ç®€æŠ¥
2. æ¸…ç†æ— æ•ˆè´¦æˆ·å’Œå†å²ä¸´æ—¶è§’è‰²

---

## 11. å¸¸è§ç®¡ç†é—®é¢˜

### 11.1 403 æ— æƒé™

å¤„ç†ï¼šæ£€æŸ¥ç”¨æˆ·è§’è‰²ã€è§’è‰²æƒé™ç»‘å®šï¼Œé‡æ–°ç™»å½•åˆ·æ–° tokenã€‚

### 11.2 çœ‹ä¸åˆ°æ•°æ®

å¤„ç†ï¼šç¡®è®¤å½“å‰è´¦å·æ‰€å±ç§Ÿæˆ·ä¸ç›®æ ‡æ•°æ®ç§Ÿæˆ·ä¸€è‡´ã€‚

### 11.3 å¯¼å‡ºå¤±è´¥

å¤„ç†ï¼šæ£€æŸ¥æœåŠ¡å†™ç›˜æƒé™ä¸ `logs/exports/` ç›®å½•çŠ¶æ€ã€‚

### 11.4 é—­ç¯ç‡å¼‚å¸¸

å¤„ç†ï¼šæ£€æŸ¥çŠ¶æ€æµè½¬æ˜¯å¦æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ˜¯å¦å­˜åœ¨é•¿æœŸ `OPEN`/`IN_PROGRESS`ã€‚


---

## 12. ½Ó¿ÚÇåµ¥¸½Â¼

ÏêÏ¸½Ó¿ÚÇë²Î¼û£ºdoc/API_Appendix_V2.0.md¡£

½¨ÒéÔÚÏµÍ³Éı¼¶ºóÍ¬²½¸´ºË¸Ã¸½Â¼ÖĞµÄÂ·¾¶ÓëÈ¨ÏŞÒªÇó¡£
