## Responsibility Header
- Role: Product milestones and outcomes (SSOT for what to deliver).
- Includes: capability roadmap, milestone goals, and product-level acceptance direction.
- Excludes: execution commands/runbooks and agent operation instructions (owned by `governance/EXECUTION_PLAYBOOK.md` and `governance/AGENTS.md`).

# governance/ROADMAP.md — 城市低空综合治理（城管巡查 B + 应急指挥 A）融合路线图

> 目标：面向政府项目的“一网统飞”平台，先可展示、可验收、可汇报，再逐步增强真实接入与规模能力。
> 现状前提：已具备单体 FastAPI + 插件式 Adapter + Postgres(PostGIS)/Redis + 事件表 + e2e 可跑通（MVP）。
> 原则：不推翻现有架构，按阶段增量交付；每阶段必须可演示、可验收、可复盘。

---

## 0. 项目叙事（对外一句话）
打造“城市低空综合治理与应急指挥平台”：一张图掌握空中力量，一套流程管巡查与应急，一条链闭环处置与留痕，一个系统支撑日常 + 突发。

---

## 1. 顶层能力地图（模块视角）

### 1.1 日常巡查（城管 B）
- 巡查模板：违建、占道经营、垃圾堆放、渣土车、露天焚烧、排污等
- 巡查任务：区域/路线/点位，周期性任务
- 巡查成果：图片/视频/位置/类型/严重度/说明
- 问题闭环：问题单→派单→整改→复核→关闭
- 统计报表：覆盖率、发现率、闭环率、处置时长、热力分布

### 1.2 突发应急（应急 A）
- 一键应急：事件创建→区域圈选→机队调度→快速起飞任务
- 态势大屏：实时位置、轨迹、告警弹窗、任务进度
- 处置闭环：告警/事件→处置建议→指令→结果回填→复盘报告
- 演练模式：可复现的演练脚本与数据回放

### 1.3 合规与留痕（政府必过）
- 多租户/组织/角色权限（RBAC）
- 审批流程（应急快速通道也要留痕）
- 禁飞区/围栏校验（PostGIS）
- 审计日志导出、操作留痕、证据链（媒体+事件）

### 1.4 设备接入（演进，不阻塞前期验收）
- FakeAdapter（CI/e2e稳定）
- MAVLink（SITL→真机）
- DJI（按 SDK/机巢能力分层）

---

## 2. 交付节奏与里程碑

### M0（已具备）
- 后端闭环：identity/registry/mission/telemetry/command/alert 基础
- FakeAdapter + e2e：一键跑通
- Docker Compose 一键启动
- 基础 RBAC / 审计 / events 表

### M1（本路线图的 6 个阶段）
按“可用→可展示→可验收→可汇报”的顺序推进。

---

## 3. 6 阶段路线图（每阶段可独立验收）

> 每阶段都包含：后端能力 + 前端展示 + 数据模型 + 验收脚本（demo/e2e）+ 报告/截图点位。

### 阶段 1：城市巡查基础版（高频可用）
**目标**：让城管“每天能用”，形成最小业务闭环（发现问题）。
- 巡查模板（基础）：违建/占道/垃圾/排污（可配置）
- 地图圈选区域创建巡查任务（区域/路线/点位）
- 巡查成果结构化（图像/位置/类型/严重度/备注）
- 生成“巡查记录单”（简版 PDF/HTML 导出）
- 前端：地图+列表，能看到巡查成果

**验收演示**：
1) 创建巡查任务 → 2) 执行（FakeAdapter）→ 3) 产生成果 → 4) 地图展示 → 5) 导出记录单

---

### 阶段 2：问题闭环流转（执法核心）
**目标**：不是发现问题，而是解决问题（闭环率）。
- 问题单/缺陷单：从巡查成果一键生成
- 状态机：待处理→处理中→已整改→待复核→已关闭
- 指派责任人/单位 + 处理记录（文本+附件）
- 复核任务：自动生成复核巡查任务
- 统计：闭环率、平均处置时长

**验收演示**：
巡查发现→生成问题单→派单→整改→复核→关闭→统计闭环率

---

### 阶段 3：应急快速建任务（3 分钟机制）
**目标**：突发事件 3 分钟内建立任务并开始态势跟踪。
- 事件（incident）模型：地点、时间、等级、描述、关联任务
- “应急模式”：圈选区域→选择机队→一键生成应急任务
- 任务优先级、资源冲突最小规则（同机不可并发）
- 处置记录：谁发起、谁审批（若走快速通道）、谁下指令

**验收演示**：
创建事件→应急模式建任务→多机轨迹→处置记录可追溯

---

### 阶段 4：指挥大屏（展示核心）
**目标**：打开系统就能展示“治理能力提升”。
- 全屏大屏：地图+设备在线+任务进度+告警弹窗+统计卡片
- 实时刷新：WebSocket 聚合（设备态势/告警/任务状态）
- 演示模式：一键生成演示数据（FakeAdapter）
- 热力图：问题分布/巡查覆盖（基础）

**验收演示**：
全屏大屏实时刷新；告警弹窗；任务进度变化；热力图与统计展示

---

### 阶段 5：合规与留痕强化（验收必过）
**目标**：满足政府项目审计/合规/可追溯要求。
- 审批流：可配置（巡查/应急不同策略）
- 禁飞区/围栏：任务创建与执行过程校验（PostGIS）
- 操作审计：关键指令、审批、任务变更、数据导出留痕
- 证据链：媒体/截图/视频（先支持文件与元数据，后续再直播）

**验收演示**：
展示审批记录、禁飞校验、审计导出、证据关联、复盘可追溯

---

### 阶段 6：汇报与考核（领导满意）
**目标**：一键生成“可汇报材料”（季度/月度/专项）。
- 指标体系：覆盖率、发现率、闭环率、响应时长、设备利用率
- 报表页面：筛选、图表、对比
- 一键生成汇报 PDF（含图表+地图截图+典型案例）
- 专项专题：某区域、某类型问题专项整治

**验收演示**：
选时间范围→生成统计→导出汇报 PDF（可直接上会）

---

## 4. 技术路线（保持现有，按需增强）

### 4.1 前端策略（建议）
- FE-1：内嵌轻量前端（Jinja2 + 静态 JS + Leaflet），不引入 Node（更稳更易自动化）
- FE-2：若后续确需复杂交互，再升级到独立前端（React/Vite）

### 4.2 事件与异步（渐进）
- 当前：events 表 + in-proc bus（已足够）
- 需要解耦时：Redis pub/sub 或轻量队列
- 真到高并发再考虑：NATS/RabbitMQ/Kafka（不作为前期硬依赖）

### 4.3 媒体能力（渐进）
- 先：MinIO + 元数据（证据链）
- 后：视频接入/转码/直播聚合（按项目需求）

### 4.4 设备接入（不阻塞主线）
- 先：FakeAdapter 保障演示与 CI
- 再：MAVLink(SITL) 做“真实可控”演示
- 后：DJI/机巢按实际采购与 SDK 能力落地

---

## 5. 每阶段交付物清单（统一要求）
- 数据模型迁移（Alembic）
- API（OpenAPI 更新 + client/postman 回归）
- 前端页面（可演示）
- e2e 脚本（可复现演示）
- 验收报告（README/截图点/演示步骤）
- CI 全绿（lint/typecheck/test/e2e）

---

## 6. 下一步（启动方式）
按顺序启动：阶段 1 → 阶段 2 → … → 阶段 6。
启动每阶段前，先输出该阶段的：
- 数据模型与表
- API 列表
- 前端页面清单
- demo/e2e 脚本步骤
- 验收标准

> 现在建议立刻启动【阶段 1：城市巡查基础版】。

---

## 7. M2-M6 阶段规划入口（基于“项目最终目标.md”）

为对齐“**一网统飞系统**”最终目标，新增后续阶段规划蓝图：

- `phases/phase-08-one-net-unified-flight-planning.md`（Phase 08-15）
- `phases/phase-16-saas-console-ui.md` ... `phases/phase-25-observability-reliability.md`（Phase 16-25）
- `phases/phase-26-ui-information-architecture-design-system.md` ... `phases/phase-31-observability-reliability-ops-console.md`（Phase 26-31）
- `phases/phase-32-role-workbench-productization.md` ... `phases/phase-39-release-adoption-lifecycle.md`（Phase 32-39）

该组蓝图定义了：
- Phase 08-31 的目标、范围、验收与退出标准
- A-J 能力映射到阶段的落地顺序
- M2/M3/M4/M5/M6 里程碑分组与执行顺序
- Phase 32-39 面向“正式交付给非技术业务人员长期使用”的产品化交付路线

新增 M7-M10 产品化交付阶段分组：
- M7（Phase 32-33）：角色化工作台 + 一张图主界面
- M8（Phase 34-35）：流程向导化 + 移动端现场执行
- M9（Phase 36-37）：业务闭环消费 + 通知协同与待办
- M10（Phase 38-39）：客户交付开通 + 上线保障与版本运营

执行建议：
- 从 `phases/state.md -> current_phase` 启动（当前为 `DONE`，表示 Phase 31 已关账，等待显式指令后再进入后续新阶段）
- 按 `phases/index.md` 顺序推进至 `phase-39-release-adoption-lifecycle.md`
- 每阶段执行时继续遵循 `phases/reporting.md` 与 `governance/AGENTS.md`
