# Tenant Boundary Matrix

Purpose: track tenant isolation maturity by domain (DB constraints, lookup scoping, and tests) for commercial multi-tenant SaaS readiness.

How to keep this updated:
- Update this matrix in the same PR as any tenant-boundary change (model, migration, service lookup, or tests).
- For DB changes, record migration revision IDs (expand/backfill/enforce).
- For lookup changes, confirm tenant-owned reads do not use id-only `session.get(...)`.
- For tests, record cross-tenant `404` coverage and DB-level enforcement (`IntegrityError`/FK failures).
- `Overall status` can be `DONE` only when DB Boundary + Lookup Boundary + Tests are all `DONE`.
- Use `PARTIAL` when boundary work is mixed (for example DB `DONE` while Lookup is `IN-PROGRESS`).
- For `Ownership=Global` models (for example `Tenant`), composite tenant constraints are not required.

| Domain | Ownership (Global / Tenant-Owned) | Tables/Models | DB Boundary status (DONE/IN-PROGRESS/PLANNED) | Lookup Boundary status (DONE/IN-PROGRESS/PLANNED) | Tests status (DONE/IN-PROGRESS/PLANNED) | Overall status (DONE/PARTIAL/PLANNED) | Risk (HIGH/MEDIUM/LOW) | Evidence (file refs + migration ids) | Next Action |
|---|---|---|---|---|---|---|---|---|---|
| Tenant Catalog | Global | `tenants` / `Tenant` | DONE (global-owner model; composite tenant-child constraints not required) | DONE (global identity flows manage tenant lookup/create paths) | DONE (tenant lifecycle covered in identity tests; cross-tenant child checks are N/A for global owner) | DONE | LOW | `app/domain/models.py:52`, `app/domain/models.py:53`, `infra/migrations/versions/202602190002_identity_phase1.py:22`, `infra/migrations/versions/202602190002_identity_phase1.py:29`, `tests/test_identity.py:47`, `tests/test_identity.py:70` | Keep tenant-name uniqueness and admin-only tenant mutation controls enforced. |
| Identity | Tenant-Owned | `users`, `roles`, `user_roles` / `User`, `Role`, `UserRole` | DONE (expand/backfill/enforce landed: `202602220008`/`202602220009`/`202602220010`) | DONE (`User`/`Role` tenant lookups use scoped query helpers; remaining `session.get` calls are global/composite-safe) | DONE (cross-tenant `404` + DB FK enforcement tests present) | DONE | LOW | `app/domain/models.py:98`, `app/domain/models.py:102`, `app/domain/models.py:107`, `infra/migrations/versions/202602220008_phase07a_identity_expand.py:14`, `infra/migrations/versions/202602220009_phase07a_identity_backfill_validate.py:14`, `infra/migrations/versions/202602220010_phase07a_identity_enforce.py:14`, `app/services/identity_service.py:61`, `app/services/identity_service.py:65`, `tests/test_identity.py:126`, `tests/test_identity.py:178` | Keep identity regression coverage green as later boundary batches land. |
| Core Batch A | Tenant-Owned | `drones`, `missions`, `mission_runs` / `Drone`, `Mission`, `MissionRun` | DONE (expand/backfill/enforce landed: `202602220011`/`202602220012`/`202602220013`) | DONE (tenant-scoped mission/drone helpers in service paths) | DONE (cross-tenant `404` + DB composite FK enforcement tests present) | DONE | LOW | `app/domain/models.py:178`, `app/domain/models.py:183`, `app/domain/models.py:222`, `app/domain/models.py:226`, `infra/migrations/versions/202602220011_phase07a_core_batch_a_expand.py:13`, `infra/migrations/versions/202602220012_phase07a_core_batch_a_backfill_validate.py:14`, `infra/migrations/versions/202602220013_phase07a_core_batch_a_enforce.py:14`, `app/services/mission_service.py:45`, `app/services/mission_service.py:53`, `tests/test_mission.py:225`, `tests/test_mission.py:315`, `phases/phase-07-master-blueprint.md:82` | Keep regression coverage green as later batches land. |
| Lookup C1 | Tenant-Owned | `InspectionTemplate`, `InspectionTask`, `InspectionExport`, `InspectionObservation`, `Defect` (service lookup batch) | DONE (lookup-hardening-only workstream; no schema change required in C1 scope) | DONE (scoped helper/query pattern in `inspection_service` + `defect_service`) | DONE (`pytest` passed for delivered C1 scope) | DONE | LOW | `app/services/inspection_service.py:40`, `app/services/inspection_service.py:50`, `app/services/inspection_service.py:60`, `app/services/defect_service.py:47`, `app/services/defect_service.py:70`, `phases/phase-07-master-blueprint.md:175`, `phases/phase-07-master-blueprint.md:177`, `phases/phase-07-master-blueprint.md:349` | Keep C1 lookup pattern as baseline for C2/C3/C4. |
| Inspection Domain | Tenant-Owned | `inspection_templates`, `inspection_template_items`, `inspection_tasks`, `inspection_observations` | IN-PROGRESS (B1 composite constraints landed via `202602230014`/`202602230015`/`202602230016`; observation/task->mission tenant composite constraints still pending) | DONE (tenant-scoped lookup hardening present in `inspection_service`) | IN-PROGRESS (DB enforcement test added; broader API cross-tenant coverage still pending) | PARTIAL | MEDIUM | `app/domain/models.py:610`, `app/domain/models.py:626`, `app/domain/models.py:654`, `app/domain/models.py:678`, `infra/migrations/versions/202602230014_phase07b_b1_inspection_expand.py:14`, `infra/migrations/versions/202602230015_phase07b_b1_inspection_backfill_validate.py:14`, `infra/migrations/versions/202602230016_phase07b_b1_inspection_enforce.py:14`, `tests/test_inspection.py:81` | Finish remaining observation/task tenant composite constraints and close service/API regression gaps. |
| Defect Domain | Tenant-Owned | `defects`, `defect_actions` / `Defect`, `DefectAction` | IN-PROGRESS (B2 landed for `defect_actions` via `202602230017`/`202602230018`/`202602230019`; `defects.observation_id` tenant composite FK still pending) | DONE (tenant-scoped lookup hardening present in `defect_service`) | IN-PROGRESS (DB enforcement test added; additional API cross-tenant lineage coverage pending) | PARTIAL | MEDIUM | `app/domain/models.py:708`, `app/domain/models.py:727`, `infra/migrations/versions/202602230017_phase07b_b2_defect_expand.py:14`, `infra/migrations/versions/202602230018_phase07b_b2_defect_backfill_validate.py:14`, `infra/migrations/versions/202602230019_phase07b_b2_defect_enforce.py:14`, `tests/test_defect.py:119` | Add tenant composite FK for `defects.observation_id` and complete defect lineage regression tests. |
| Incident Domain | Tenant-Owned | `incidents` / `Incident` | DONE (expand/backfill/enforce landed: `202602230020`/`202602230021`/`202602230022`) | DONE (incident id paths now use tenant-scoped helper/query) | IN-PROGRESS (DB-level FK enforcement test present; API lifecycle cross-tenant coverage still pending) | PARTIAL | MEDIUM | `app/domain/models.py:748`, `app/services/incident_service.py:31`, `infra/migrations/versions/202602230020_phase07b_b3_incident_alert_expand.py:14`, `infra/migrations/versions/202602230021_phase07b_b3_incident_alert_backfill_validate.py:14`, `infra/migrations/versions/202602230022_phase07b_b3_incident_alert_enforce.py:14`, `tests/test_incident.py:27` | Add incident service/API regression tests for cross-tenant `404` lifecycle paths. |
| Alert Domain | Tenant-Owned | `alerts` / `AlertRecord` | IN-PROGRESS (tenant index exists; composite tenant-child FK enforcement for drone linkage not landed) | DONE (get/ack/close paths now use tenant-scoped alert helper) | IN-PROGRESS (alert tests exist; explicit DB boundary/assert coverage still incomplete) | PARTIAL | MEDIUM | `app/domain/models.py:343`, `app/services/alert_service.py:40`, `app/services/alert_service.py:187`, `app/services/alert_service.py:206`, `app/services/alert_service.py:251`, `tests/test_alert.py`, `infra/migrations/versions/202602190006_alert_phase7.py:14` | Deliver remaining DB boundary constraints for alert lineage and strengthen cross-tenant regression tests. |
| Command Domain | Tenant-Owned | `command_requests` / `CommandRequestRecord` | DONE (B4 expand/backfill/enforce landed: `202602240023`/`202602240024`/`202602240025`) | DONE (command/drone id paths use tenant-scoped helpers) | DONE (cross-tenant `404` + DB composite FK enforcement tests present) | DONE | LOW | `app/domain/models.py:297`, `app/services/command_service.py:63`, `app/services/command_service.py:77`, `app/services/command_service.py:92`, `infra/migrations/versions/202602240023_phase07b_b4_command_expand.py:14`, `infra/migrations/versions/202602240024_phase07b_b4_command_backfill_validate.py:14`, `infra/migrations/versions/202602240025_phase07b_b4_command_enforce.py:14`, `tests/test_command.py:176`, `tests/test_command.py:200` | Keep command boundary regressions green during 07C tenant export/purge rollout. |
| Reporting / Compliance | Tenant-Owned | `approval_records` / `ApprovalRecord` + reporting aggregates | DONE (B5 expand/backfill/enforce landed: `202602240026`/`202602240027`/`202602240028`; composite `(tenant_id, approved_by) -> users(tenant_id, id)` enforced) | DONE (reporting/compliance reads stay tenant-filtered; no id-only `session.get`) | DONE (tenant-scope API regression + DB composite FK enforcement tests present) | DONE | LOW | `app/domain/models.py:783`, `app/domain/models.py:793`, `infra/migrations/versions/202602240026_phase07b_b5_reporting_export_expand.py:13`, `infra/migrations/versions/202602240027_phase07b_b5_reporting_export_backfill_validate.py:14`, `infra/migrations/versions/202602240028_phase07b_b5_reporting_export_enforce.py:14`, `app/services/compliance_service.py:49`, `app/services/reporting_service.py:29`, `tests/test_compliance.py:81`, `tests/test_compliance.py:112`, `tests/test_reporting.py:85` | Move focus to 07C dry-run/execute purge boundaries while keeping reporting/compliance regressions green. |
| Registry Credentials (Discovered) | Tenant-Owned | `drone_credentials` / `DroneCredential` | IN-PROGRESS (`drone_id -> drones.id` is single-column FK; tenant match is not DB-enforced) | PLANNED (no dedicated tenant-scoped helper path for credentials) | PLANNED (no registry-credential boundary tests found) | PARTIAL | HIGH | `app/domain/models.py:154`, `app/domain/models.py:159`, `infra/migrations/versions/202602190003_registry_phase2.py:14`, `infra/migrations/versions/202602190003_registry_phase2.py:40`, `infra/migrations/versions/202602190003_registry_phase2.py:46` | Treat as high-priority: add composite `(tenant_id, drone_id)` FK + scoped lookup helper + cross-tenant credential access tests. |
