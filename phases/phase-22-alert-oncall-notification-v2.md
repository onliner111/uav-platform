# Phase 22 - 告警值班与通知体系 v2

## 0. Basis
- Based on: `111.md`
- Depends on: `phases/phase-21-airspace-compliance-hub-v2.md`

## 1. Objective
将告警从“站内处理”升级到“值班驱动 + 多渠道通知 + 升级策略”的运营级体系。

## 2. Scope
- 值班表与轮班策略
- 告警升级策略（超时、重复、跨班次）
- 通知渠道接入（短信/邮件/企业 IM）
- 告警聚合与静默规则
- 告警处置 SLA 统计

## 3. Out of Scope
- 第三方通知平台深度计费结算
- 全自动应急处置编排

## 4. Deliverables
- 值班与升级策略模型及 API
- 通知适配层与发送回执接口
- 告警聚合/静默规则引擎最小实现
- 告警 SLA 报表与回归测试

## 5. Acceptance
- 值班规则可稳定路由告警
- 超时告警可自动升级
- 多渠道通知可观测、可追踪
- 告警闭环与 SLA 指标可输出

### 5.1 Quantitative Acceptance（量化验收）
- `P1` 告警：未 ACK 超过 `5` 分钟触发升级
- `P2` 告警：未 ACK 超过 `10` 分钟触发升级
- `P3` 告警：未 ACK 超过 `30` 分钟触发升级
- 相同告警（同 `alert_id`）同一升级层级仅执行一次（幂等）
- 通知链路至少提供 `2` 种可用通道（`IN_APP + WEBHOOK`），第三种可为模拟通道
- SLA 最小指标必须可查询：`MTTA`（首次 ACK）、`MTTR`（关闭耗时）、超时升级率

## 6. Exit Criteria
- `ruff`, `mypy`, `pytest`, `e2e` 全绿
- 值班通知演示脚本可复跑

---

## 7. Priority Tuning (P0/P1/P2)

- P0（先做，阻塞运营闭环）：
  - `22-WP1` 值班表与升级策略最小闭环
  - `22-WP2` 通知渠道最小接入（至少 2 种）
- P1（随后完成，形成值守效率）：
  - `22-WP3` 聚合与静默规则 + 告警 SLA 统计与报表
- P2（可延后到本阶段后半）：
  - 在 `22-WP3` 基础上补齐智能去重与噪声压制优化
- 执行顺序：`P0 -> P1 -> P2 -> 22-WP4`

## 8. Execution Progress

- [x] 22-WP1 值班与升级策略最小闭环
- [x] 22-WP2 通知渠道接入
- [x] 22-WP3 聚合静默与 SLA 报表
- [x] 22-WP4 验收关账

## 9. Implementation Contract（实现约束）

### 9.1 WP1（P0）最小闭环必须包含
- 值班排班模型（班次时间窗、值班目标、状态）
- 升级策略模型（按优先级配置 ACK 超时阈值、重复触发阈值、最大升级层级）
- 升级执行接口（显式触发，便于测试与演示）：`POST /api/alert/alerts:escalation-run`
- 升级触发原因最小集合：`ack_timeout`、`repeat_trigger`、`shift_handover`

### 9.2 路由与升级顺序
- 路由解析顺序：显式目标 > `oncall://active` 动态解析 > 默认兜底目标
- 规则冲突顺序（Phase 22 内统一）：`静默 > 聚合 > 升级 > 通知`
- 升级过程必须写入动作链与路由日志，确保可追溯

### 9.3 时间语义
- 后端统一使用 `UTC`
- 值班班次允许声明时区信息（展示用），判定逻辑以 UTC 存储值为准
- 跨班次判定必须基于“当前有效班次目标”与“最近一次路由目标”比较

### 9.4 外部依赖策略
- 不阻塞于第三方通道联调；先以适配层 + 模拟发送完成闭环
- 第三方通道失败时不得中断告警主流程，需落库记录失败原因与重试线索
