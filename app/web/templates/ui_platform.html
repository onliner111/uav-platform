{% extends "console_base.html" %}

{% block content %}
<div class="cards ui-kpi-grid">
  <div class="card ui-kpi-card">
    <div>租户</div>
    <div class="value">{{ tenants|length }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>用户</div>
    <div class="value">{{ users|length }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>角色</div>
    <div class="value">{{ roles|length }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>组织单元</div>
    <div class="value">{{ org_units|length }}</div>
  </div>
</div>

<div class="panel">
  <h2>租户</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for item in tenants %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.created_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>用户</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Active</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for item in users %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.username }}</td>
          <td>{{ item.is_active }}</td>
          <td>{{ item.created_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>角色</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>System</th>
        </tr>
      </thead>
      <tbody>
        {% for item in roles %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.description or "-" }}</td>
          <td>{{ item.is_system }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>组织单元</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Type</th>
          <th>Parent</th>
          <th>Active</th>
        </tr>
      </thead>
      <tbody>
        {% for item in org_units %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.node_type }}</td>
          <td>{{ item.parent_id or "-" }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>角色模板</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>Template Key</th>
          <th>Name</th>
          <th>Description</th>
          <th>Permissions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in role_templates %}
        <tr>
          <td><code>{{ item.template_key }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.description or "-" }}</td>
          <td>{{ item.permission_names|length }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>RBAC 可见性矩阵</h2>
  <p class="hint">该页是管理员工具，用于查看页面级和动作级可见性规则，不面向普通业务用户。</p>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>Group</th>
          <th>Page</th>
          <th>Route</th>
          <th>Page Permission</th>
          <th>Write Permission</th>
          <th>Write Actions</th>
          <th>View</th>
          <th>Write</th>
        </tr>
      </thead>
      <tbody>
        {% for item in visibility_matrix %}
        <tr>
          <td>{{ item.group }}</td>
          <td>{{ item.page }}</td>
          <td><code>{{ item.route }}</code></td>
          <td><code>{{ item.page_permission }}</code></td>
          <td><code>{{ item.write_permission }}</code></td>
          <td>{{ item.write_actions }}</td>
          <td><span class="status-pill {% if not item.can_view %}danger{% endif %}">{% if item.can_view %}ALLOW{% else %}DENY{% endif %}</span></td>
          <td><span class="status-pill {% if item.can_write %}warn{% else %}danger{% endif %}">{% if item.can_write %}ALLOW{% else %}DENY{% endif %}</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>治理快捷入口</h2>
  <div class="hero-actions">
    <a class="button-link ghost-link" href="/api/identity/role-templates" target="_blank" rel="noopener noreferrer">角色模板 API</a>
    <a class="button-link ghost-link" href="/api/identity/permissions" target="_blank" rel="noopener noreferrer">权限 API</a>
    <a class="button-link ghost-link" href="/api/tenants/{{ tenant_id }}/export" target="_blank" rel="noopener noreferrer">租户导出</a>
  </div>
  {% if can_identity_write %}
  <p class="hint">当前账号拥有 <code>identity.write</code> 权限，可执行平台治理写操作。</p>
  {% endif %}
</div>
{% endblock %}
