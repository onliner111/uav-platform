{% extends "console_base.html" %}

{% block content %}
<div class="selection-banner admin-rail">
  <strong>管理员技术页：</strong>此页面面向平台管理员和算法治理角色，不作为普通业务人员的日常入口。
</div>
<div class="stack-gap-md"></div>
<div class="panel">
  <div class="table-panel-head">
    <h2>管理员关联入口</h2>
    <p class="table-panel-note">当前位置：算法治理分组。可与 AI 治理、成果报表和平台治理联动使用。</p>
  </div>
  <div class="admin-link-grid">
    <a class="admin-link-card active" href="/ui/ai-governance?token={{ token }}">
      <span class="admin-link-title">AI 治理</span>
      <span class="admin-link-desc">管理模型、版本、发布和审核。</span>
    </a>
    <a class="admin-link-card" href="/ui/reports?token={{ token }}">
      <span class="admin-link-title">成果数据</span>
      <span class="admin-link-desc">查看输出成果和报表消费链路。</span>
    </a>
    <a class="admin-link-card" href="/ui/platform?token={{ token }}">
      <span class="admin-link-title">平台治理</span>
      <span class="admin-link-desc">核对权限、审计与治理策略。</span>
    </a>
  </div>
</div>
<div class="cards ui-kpi-grid">
  <div class="card ui-kpi-card">
    <div>模型目录</div>
    <div class="value">{{ model_catalogs|length if can_ai_data_read else 0 }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>作业</div>
    <div class="value">{{ jobs|length if can_ai_data_read else 0 }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>输出结果</div>
    <div class="value">{{ outputs|length if can_ai_data_read else 0 }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>写入权限</div>
    <div class="value">{{ "已开启" if can_ai_data_write else "只读" }}</div>
  </div>
</div>

<div class="panel">
  <h2>模型目录与版本治理</h2>
  {% if can_ai_data_read %}
  <div class="grid cols-2">
    <div class="form-stack">
      <h3>创建模型目录</h3>
      <label>模型标识（系统）</label>
      <input id="ai-model-key" placeholder="builtin:uav-assistant-lite" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">供应商来源</label>
      <input id="ai-model-provider" value="builtin" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">模型显示名称</label>
      <input id="ai-model-display-name" value="uav-assistant-lite" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">说明（可选）</label>
      <input id="ai-model-description" placeholder="可选说明" {% if not can_ai_data_write %}disabled{% endif %}>
      <button id="ai-model-create-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>创建模型</button>
      <label class="stack-gap-sm">筛选：模型标识</label>
      <input id="ai-model-filter-key" placeholder="按模型标识筛选">
      <label class="stack-gap-sm">筛选：供应商来源</label>
      <input id="ai-model-filter-provider" placeholder="按供应商筛选">
      <button id="ai-model-list-btn" type="button" class="stack-gap-sm">加载模型</button>
      <pre id="ai-model-box" class="hint pre-box result-surface stack-gap-sm">尚未发起模型查询。</pre>
    </div>
    <div class="form-stack">
      <h3>版本与晋升</h3>
      <label>模型标识</label>
      <input id="ai-version-model-id" placeholder="输入关联模型标识" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">版本号</label>
      <input id="ai-version-value" placeholder="phase29.v1" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">初始状态</label>
      <select id="ai-version-status" {% if not can_ai_data_write %}disabled{% endif %}>
        {% for item in ai_version_status_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label class="stack-gap-sm">阈值配置（JSON，高级配置）</label>
      <textarea id="ai-version-thresholds" rows="3" placeholder='{"confidence_min":0.8}' {% if not can_ai_data_write %}disabled{% endif %}></textarea>
      <button id="ai-version-create-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>创建版本</button>
      <label class="stack-gap-sm">待发布版本标识</label>
      <input id="ai-promote-version-id" placeholder="可由创建版本自动带入" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">目标状态</label>
      <select id="ai-promote-status" {% if not can_ai_data_write %}disabled{% endif %}>
        {% for item in ai_version_status_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <button id="ai-promote-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>晋升版本</button>
      <button id="ai-version-list-btn" type="button" class="stack-gap-sm">查看版本列表</button>
      <pre id="ai-version-box" class="hint pre-box result-surface stack-gap-sm">尚未发起版本查询。</pre>
    </div>
  </div>
  {% else %}
  <p class="hint">当前账号缺少 <code>ai.read</code> 或 <code>reporting.read</code>，AI 数据已隐藏。</p>
  {% endif %}
</div>

<div class="panel">
  <h2>发布策略、对比与回滚</h2>
  <div class="grid cols-2">
    <div class="form-stack">
      <h3>发布策略</h3>
      <label>模型标识</label>
      <input id="ai-policy-model-id" placeholder="输入模型标识" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">默认版本标识</label>
      <input id="ai-policy-default-version-id" placeholder="可选" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">流量分配（JSON，高级配置）</label>
      <textarea id="ai-policy-traffic" rows="3" placeholder='[{"version_id":"...","weight":100}]' {% if not can_ai_data_write %}disabled{% endif %}></textarea>
      <label class="stack-gap-sm">阈值覆盖（JSON，高级配置）</label>
      <textarea id="ai-policy-threshold" rows="3" placeholder='{"confidence_min":0.75}' {% if not can_ai_data_write %}disabled{% endif %}></textarea>
      <p class="hint admin-note stack-gap-sm">流量与阈值 JSON 仅建议算法治理管理员修改，普通运营不应直接编辑。</p>
      <button id="ai-policy-upsert-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>保存策略</button>
      <button id="ai-policy-get-btn" type="button" class="stack-gap-sm">查看策略</button>
      <label class="stack-gap-sm">回滚目标版本标识</label>
      <input id="ai-rollback-target-version-id" placeholder="输入目标版本标识" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">回滚原因</label>
      <input id="ai-rollback-reason" placeholder="填写原因" {% if not can_ai_data_write %}disabled{% endif %}>
      <button id="ai-rollback-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>执行回滚</button>
      <pre id="ai-policy-box" class="hint pre-box result-surface stack-gap-sm">尚未执行发布策略动作。</pre>
    </div>
    <div class="form-stack">
      <h3>评估重算与版本对比</h3>
      <label>重算模型标识（可选）</label>
      <input id="ai-recompute-model-id" placeholder="按模型范围重算" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">重算作业标识（可选）</label>
      <input id="ai-recompute-job-id" placeholder="按作业范围重算" {% if not can_ai_data_write %}disabled{% endif %}>
      <button id="ai-recompute-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>执行重算</button>
      <label class="stack-gap-sm">左侧版本标识</label>
      <input id="ai-compare-left-version-id" placeholder="基准版本">
      <label class="stack-gap-sm">右侧版本标识</label>
      <input id="ai-compare-right-version-id" placeholder="对比版本">
      <label class="stack-gap-sm">对比作业标识（可选）</label>
      <input id="ai-compare-job-id" placeholder="可留空">
      <button id="ai-compare-btn" type="button" class="stack-gap-sm">执行对比</button>
      <pre id="ai-eval-box" class="hint pre-box result-surface stack-gap-sm">尚未执行评估动作。</pre>
    </div>
  </div>
</div>

<div class="panel">
  <h2>作业、运行与证据回放</h2>
  <div class="grid cols-2">
    <div class="form-stack">
      <h3>作业与运行操作</h3>
      <label>关联任务标识（可选）</label>
      <input id="ai-job-task-id" placeholder="按任务绑定" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">关联任务批次标识（可选）</label>
      <input id="ai-job-mission-id" placeholder="按任务批次绑定" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">主题（可选）</label>
      <input id="ai-job-topic" placeholder="defect" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">作业类型</label>
      <select id="ai-job-type" {% if not can_ai_data_write %}disabled{% endif %}>
        <option value="SUMMARY">摘要</option>
        <option value="SUGGESTION">建议</option>
      </select>
      <label class="stack-gap-sm">触发方式</label>
      <select id="ai-job-trigger-mode" {% if not can_ai_data_write %}disabled{% endif %}>
        <option value="MANUAL">手动</option>
        <option value="SCHEDULED">定时</option>
        <option value="NEAR_REALTIME">准实时</option>
      </select>
      <label class="stack-gap-sm">绑定模型版本标识（可选）</label>
      <input id="ai-job-model-version-id" placeholder="按指定版本运行" {% if not can_ai_data_write %}disabled{% endif %}>
      <button id="ai-job-create-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>创建作业</button>
      <label class="stack-gap-sm">作业标识</label>
      <input id="ai-job-id" placeholder="可由创建作业自动带入">
      <button id="ai-jobs-list-btn" type="button" class="stack-gap-sm">查看作业</button>
      <button id="ai-runs-list-btn" type="button" class="stack-gap-sm">查看运行</button>
      <button id="ai-run-trigger-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>触发运行</button>
      <label class="stack-gap-sm">重试运行标识</label>
      <input id="ai-retry-run-id" placeholder="输入运行标识" {% if not can_ai_data_write %}disabled{% endif %}>
      <button id="ai-run-retry-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>重试运行</button>
      <pre id="ai-job-run-box" class="hint pre-box result-surface stack-gap-sm">尚未执行作业或运行动作。</pre>
    </div>
    <div class="form-stack">
      <h3>输出审核与证据链</h3>
      <label>按作业标识筛选</label>
      <input id="ai-output-filter-job-id" placeholder="可留空">
      <label class="stack-gap-sm">按运行标识筛选</label>
      <input id="ai-output-filter-run-id" placeholder="可留空">
      <label class="stack-gap-sm">审核状态</label>
      <select id="ai-output-filter-status">
        <option value="">全部</option>
        {% for item in ai_output_review_status_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <button id="ai-outputs-list-btn" type="button" class="stack-gap-sm">查看输出</button>
      <label class="stack-gap-sm">输出标识</label>
      <input id="ai-output-id" placeholder="输入输出标识">
      <button id="ai-output-review-get-btn" type="button" class="stack-gap-sm">加载审核资料</button>
      <label class="stack-gap-sm">审核动作</label>
      <select id="ai-review-action" {% if not can_ai_data_write %}disabled{% endif %}>
        {% for item in ai_review_action_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label class="stack-gap-sm">审核备注</label>
      <input id="ai-review-note" placeholder="填写审核说明" {% if not can_ai_data_write %}disabled{% endif %}>
      <label class="stack-gap-sm">人工覆盖内容（JSON，高级配置）</label>
      <textarea id="ai-review-override" rows="3" placeholder='{"summary":"manual summary","suggestion":"manual suggestion"}' {% if not can_ai_data_write %}disabled{% endif %}></textarea>
      <p class="hint admin-note stack-gap-sm">人工覆盖内容仅在需替换模型输出时使用，常规审核建议只填写审核动作和备注。</p>
      <button id="ai-output-review-submit-btn" type="button" class="stack-gap-sm" {% if not can_ai_data_write %}disabled{% endif %}>提交审核</button>
      <pre id="ai-output-box" class="hint pre-box result-surface stack-gap-sm">尚未加载输出审核数据。</pre>
    </div>
  </div>
</div>

<div class="panel">
  <div class="table-panel-head">
    <h2>模型目录快照</h2>
    <p class="table-panel-note">便于管理员快速核对当前模型目录、供应商和启用状态。</p>
  </div>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>标识</th>
          <th>模型标识</th>
          <th>供应商</th>
          <th>显示名称</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in model_catalogs %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>
            <span class="cell-main">模型标识</span>
            <code class="cell-subtle">{{ item.model_key }}</code>
          </td>
          <td>
            <span class="cell-main">
              {{ "内置模型" if item.provider == "builtin" else "外部供应商" if item.provider else "未标注" }}
            </span>
            <code class="cell-subtle">{{ item.provider or "-" }}</code>
          </td>
          <td>{{ item.display_name }}</td>
          <td><span class="status-pill {{ 'success' if item.is_active else 'muted' }}">{{ "已启用" if item.is_active else "已停用" }}</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<pre class="hint pre-box action-result result-box result-surface" id="ai-governance-result" role="status" aria-live="polite"></pre>
{% endblock %}

{% block scripts %}
<script>
  window.__CAN_AI_DATA_READ = {{ can_ai_data_read | tojson }};
  window.__CAN_AI_DATA_WRITE = {{ can_ai_data_write | tojson }};
</script>
<script src="/static/ai_governance_ui.js"></script>
{% endblock %}
