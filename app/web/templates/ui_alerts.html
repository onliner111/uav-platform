{% extends "console_base.html" %}

{% block content %}
<div class="cards ui-kpi-grid">
  <div class="card ui-kpi-card">
    <div>待处理告警</div>
    <div class="value">{{ alert_status_counts.get("OPEN", 0) }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>已确认告警</div>
    <div class="value">{{ alert_status_counts.get("ACKED", 0) }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>已关闭告警</div>
    <div class="value">{{ alert_status_counts.get("CLOSED", 0) }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>值守班次 / 升级策略</div>
    <div class="value">{{ oncall_shifts|length }} / {{ escalation_policies|length }}</div>
  </div>
</div>

<div class="panel">
  <div class="ui-section-head">
      <h2>告警队列</h2>
    <form method="get" action="/ui/alerts" class="ui-action-row">
      <input type="hidden" name="token" value="{{ token }}">
      <select name="alert_status" aria-label="按告警状态筛选">
        <option value="">全部状态</option>
        {% for item in alert_status_options %}
        <option value="{{ item }}" {% if selected_alert_status == item %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
      <input name="drone_id" value="{{ selected_alert_drone }}" placeholder="按设备标识筛选（可选）">
      <button type="submit">筛选告警</button>
    </form>
  </div>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>告警 ID</th>
          <th>设备</th>
          <th>类型</th>
          <th>优先级</th>
          <th>状态</th>
          <th>最近出现</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for item in alerts %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.drone_id }}</td>
          <td>{{ item.alert_type }}</td>
          <td>{{ item.priority_level }}</td>
          <td><span class="status-pill">{{ item.status }}</span></td>
          <td>{{ item.last_seen_at }}</td>
          <td>
            <button type="button" class="table-select js-alert-select" data-alert-id="{{ item.id }}">选中</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <div id="alert-selection-banner" class="selection-banner" style="margin-bottom:12px;">
    <strong>当前未选中告警</strong>
    <div class="selection-meta">建议先在上方列表点击“选中”，系统会自动带入当前告警到处理区。</div>
  </div>
  <h2>当前告警处理</h2>
  <div class="grid cols-2">
    <div>
      <h3>确认告警</h3>
      <label>当前告警</label>
      <input id="alert-ack-id" placeholder="可从上方列表自动带入">
      <label style="margin-top:8px;">备注</label>
      <input id="alert-ack-comment" placeholder="可选，填写确认备注">
      <button id="alert-ack-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>确认告警</button>
    </div>
    <div>
      <h3>关闭告警</h3>
      <label>当前告警</label>
      <input id="alert-close-id" placeholder="可从上方列表自动带入">
      <label style="margin-top:8px;">备注</label>
      <input id="alert-close-comment" placeholder="可选，填写关闭说明">
      <button id="alert-close-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>关闭告警</button>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:12px;">
    <div>
      <h3>创建路由规则</h3>
      <label>优先级</label>
      <select id="routing-priority">
        {% for item in alert_priority_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">告警类型（可选）</label>
      <select id="routing-type">
        <option value="">全部类型</option>
        {% for item in alert_type_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">通知渠道</label>
      <select id="routing-channel">
        {% for item in alert_channel_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">目标</label>
      <input id="routing-target" placeholder="例如：oncall://active 或用户标识">
      <button id="routing-create-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>创建路由规则</button>
    </div>
    <div>
      <h3>创建值守班次</h3>
      <label>班次名称</label>
      <input id="oncall-name" value="day-shift">
      <label style="margin-top:8px;">目标</label>
      <input id="oncall-target" value="oncall://active">
      <label style="margin-top:8px;">开始时间（ISO）</label>
      <input id="oncall-starts-at" placeholder="2026-03-01T00:00:00Z">
      <label style="margin-top:8px;">结束时间（ISO）</label>
      <input id="oncall-ends-at" placeholder="2026-03-01T08:00:00Z">
      <label style="margin-top:8px;">时区</label>
      <input id="oncall-timezone" value="UTC">
      <button id="oncall-create-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>创建班次</button>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:12px;">
    <div>
      <h3>创建升级策略</h3>
      <label>优先级</label>
      <select id="escalation-priority">
        {% for item in alert_priority_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">确认超时（秒）</label>
      <input id="escalation-ack-timeout" type="number" min="30" value="1800">
      <label style="margin-top:8px;">重复阈值</label>
      <input id="escalation-repeat-threshold" type="number" min="2" value="3">
      <label style="margin-top:8px;">最大升级级别</label>
      <input id="escalation-max-level" type="number" min="1" value="1">
      <label style="margin-top:8px;">通知渠道</label>
      <select id="escalation-channel">
        {% for item in alert_channel_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">目标</label>
      <input id="escalation-target" value="oncall://active">
      <button id="escalation-create-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>创建升级策略</button>
    </div>
    <div>
      <h3>升级策略试运行</h3>
      <label>演练模式</label>
      <select id="escalation-run-dry">
        <option value="false">正式执行</option>
        <option value="true">演练模式</option>
      </select>
      <label style="margin-top:8px;">扫描上限</label>
      <input id="escalation-run-limit" type="number" min="1" max="1000" value="200">
      <button id="escalation-run-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>运行升级策略</button>
      <pre id="escalation-run-box" class="hint" style="white-space:pre-wrap; margin-top:8px;">尚未执行升级策略。</pre>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:12px;">
    <div>
      <h3>创建静默规则</h3>
      <label>规则名称</label>
      <input id="silence-name" value="silent-window">
      <label style="margin-top:8px;">告警类型（可选）</label>
      <select id="silence-type">
        <option value="">全部类型</option>
        {% for item in alert_type_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">设备标识（可选）</label>
      <input id="silence-drone-id" placeholder="请输入设备标识">
      <label style="margin-top:8px;">开始时间（可选 ISO）</label>
      <input id="silence-starts-at" placeholder="2026-03-01T00:00:00Z">
      <label style="margin-top:8px;">结束时间（可选 ISO）</label>
      <input id="silence-ends-at" placeholder="2026-03-01T08:00:00Z">
      <button id="silence-create-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>创建静默规则</button>
    </div>
    <div>
      <h3>创建聚合规则</h3>
      <label>规则名称</label>
      <input id="aggregation-name" value="aggregation-rule">
      <label style="margin-top:8px;">告警类型（可选）</label>
      <select id="aggregation-type">
        <option value="">全部类型</option>
        {% for item in alert_type_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">聚合窗口（秒）</label>
      <input id="aggregation-window" type="number" min="10" value="300">
      <button id="aggregation-create-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>创建聚合规则</button>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:12px;">
    <div>
      <h3>查看路由 / 动作 / 复盘</h3>
      <label>当前告警</label>
      <input id="alert-review-id" placeholder="可从上方列表自动带入">
      <div class="ui-action-row" style="margin-top:10px;">
        <button id="alert-routes-btn" type="button">查看路由</button>
        <button id="alert-actions-btn" type="button">查看动作</button>
        <button id="alert-review-btn" type="button">查看复盘</button>
      </div>
      <pre id="alert-review-box" class="hint" style="white-space:pre-wrap; margin-top:8px;">尚未加载数据。</pre>
    </div>
    <div>
      <h3>补充处理动作</h3>
      <label>当前告警</label>
      <input id="alert-action-id" placeholder="可从上方列表自动带入">
      <label style="margin-top:8px;">动作类型</label>
      <select id="alert-action-type" {% if not can_alert_write %}disabled{% endif %}>
        {% for item in alert_action_type_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <label style="margin-top:8px;">说明</label>
      <input id="alert-action-note" placeholder="可选，填写处理说明" {% if not can_alert_write %}disabled{% endif %}>
      <button id="alert-action-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>新增动作</button>
      <label style="margin-top:8px;">路由日志标识</label>
      <input id="route-receipt-id" placeholder="请输入路由日志标识" {% if not can_alert_write %}disabled{% endif %}>
      <label style="margin-top:8px;">投递状态</label>
      <select id="route-receipt-status" {% if not can_alert_write %}disabled{% endif %}>
        {% for item in alert_delivery_status_options %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
      <button id="route-receipt-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>提交回执</button>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:12px;">
    <div>
      <h3>值守 SLA 概览</h3>
      <label>开始时间（可选 ISO）</label>
      <input id="sla-from-ts" placeholder="2026-03-01T00:00:00Z">
      <label style="margin-top:8px;">结束时间（可选 ISO）</label>
      <input id="sla-to-ts" placeholder="2026-03-01T08:00:00Z">
      <button id="sla-load-btn" type="button" style="margin-top:10px;">加载 SLA</button>
      <pre id="sla-box" class="hint" style="white-space:pre-wrap; margin-top:8px;">尚无 SLA 数据。</pre>
    </div>
    <div>
      <h3>批量关闭</h3>
      <label>告警标识（每行一个）</label>
      <textarea id="batch-close-ids" rows="5" placeholder="alert-id-a&#10;alert-id-b" {% if not can_alert_write %}disabled{% endif %}></textarea>
      <label style="margin-top:8px;">备注</label>
      <input id="batch-close-comment" placeholder="可选，填写批量关闭说明" {% if not can_alert_write %}disabled{% endif %}>
      <button id="batch-close-btn" type="button" style="margin-top:10px;" {% if not can_alert_write %}disabled{% endif %}>批量关闭</button>
      {% if not can_alert_write %}
      <p class="hint">当前为只读模式，需要 `alert.write` 权限才能执行写操作。</p>
      {% endif %}
    </div>
  </div>

  <div class="hint action-result" id="alerts-result" role="status" aria-live="polite"></div>
</div>

<div class="panel">
  <h2>路由规则</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>标识</th>
          <th>优先级</th>
          <th>告警类型</th>
          <th>通知渠道</th>
          <th>通知目标</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in routing_rules %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.priority_level }}</td>
          <td>{{ item.alert_type or "-" }}</td>
          <td>{{ item.channel }}</td>
          <td>{{ item.target }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>值守班次</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>标识</th>
          <th>班次名称</th>
          <th>通知目标</th>
          <th>开始时间</th>
          <th>结束时间</th>
          <th>时区</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in oncall_shifts %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.shift_name }}</td>
          <td>{{ item.target }}</td>
          <td>{{ item.starts_at }}</td>
          <td>{{ item.ends_at }}</td>
          <td>{{ item.timezone }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>升级策略</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>标识</th>
          <th>优先级</th>
          <th>确认超时</th>
          <th>重复阈值</th>
          <th>最大级别</th>
          <th>通知渠道</th>
          <th>通知目标</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in escalation_policies %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.priority_level }}</td>
          <td>{{ item.ack_timeout_seconds }}</td>
          <td>{{ item.repeat_threshold }}</td>
          <td>{{ item.max_escalation_level }}</td>
          <td>{{ item.escalation_channel }}</td>
          <td>{{ item.escalation_target }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>静默规则</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>标识</th>
          <th>规则名称</th>
          <th>告警类型</th>
          <th>设备</th>
          <th>生效窗口</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in silence_rules %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.alert_type or "-" }}</td>
          <td>{{ item.drone_id or "-" }}</td>
          <td>{{ item.starts_at or "-" }} ~ {{ item.ends_at or "-" }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>聚合规则</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>标识</th>
          <th>规则名称</th>
          <th>告警类型</th>
          <th>窗口（秒）</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in aggregation_rules %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.alert_type or "-" }}</td>
          <td>{{ item.window_seconds }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.__CAN_ALERT_WRITE = {{ can_alert_write | tojson }};
</script>
<script src="/static/alerts_ui.js"></script>
{% endblock %}
