{% extends "console_base.html" %}

{% block content %}
<div class="cards ui-kpi-grid">
  <div class="card ui-kpi-card">
    <div>任务总量</div>
    <div class="value">{{ tasks|length }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>待审批</div>
    <div class="value">{{ task_state_counts.get("APPROVAL_PENDING", 0) }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>执行中</div>
    <div class="value">{{ task_state_counts.get("IN_PROGRESS", 0) }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>模板 / 类型</div>
    <div class="value">{{ templates|length }} / {{ task_types|length }}</div>
  </div>
</div>

<div class="panel">
  <div class="ui-section-head">
    <div>
      <h2>任务队列</h2>
      <p class="ui-section-subtitle">先从列表选中任务，再执行流转、派发、审批和评论。</p>
    </div>
    <form method="get" action="/ui/task-center" class="ui-action-row">
      <input type="hidden" name="token" value="{{ token }}">
      <select name="state" aria-label="按状态筛选任务">
        <option value="">全部状态</option>
        {% for state in task_state_options %}
        <option value="{{ state }}" {% if selected_task_state == state %}selected{% endif %}>{{ state }}</option>
        {% endfor %}
      </select>
      <button type="submit">筛选任务</button>
    </form>
  </div>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>任务 ID</th>
          <th>任务名称</th>
          <th>状态</th>
          <th>优先级</th>
          <th>派发模式</th>
          <th>处理人</th>
          <th>更新时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for item in tasks %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td><span class="status-pill">{{ item.state }}</span></td>
          <td>{{ item.priority }}</td>
          <td>{{ item.dispatch_mode }}</td>
          <td>{{ item.assigned_to or "-" }}</td>
          <td>{{ item.updated_at }}</td>
          <td>
            <button
              type="button"
              class="table-select js-task-select"
              data-task-id="{{ item.id }}"
              data-task-name="{{ item.name }}"
              data-task-state="{{ item.state }}"
              data-task-assigned="{{ item.assigned_to or '-' }}"
            >
              选中
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if can_task_write %}
<div class="panel">
  <div id="task-selection-banner" class="selection-banner">
    <strong>当前未选中任务</strong>
    <div class="selection-meta">建议先在上方列表点击“选中”，系统会自动带入当前任务到主要操作区。</div>
  </div>

  <div class="action-deck" style="margin-top:12px;">
    <div class="action-cluster primary">
      <h3>主处理动作</h3>
      <p>围绕当前任务完成状态流转、派发和审批提交。</p>
      <div class="grid cols-2">
        <div>
          <h4>流转任务状态</h4>
          <label>任务 ID</label>
          <input id="task-transition-id" placeholder="可从上方列表自动带入">
          <label style="margin-top:8px;">目标状态</label>
          <select id="task-transition-state">
            {% for state in task_state_options %}
            <option value="{{ state }}">{{ state }}</option>
            {% endfor %}
          </select>
          <label style="margin-top:8px;">说明</label>
          <input id="task-transition-note" placeholder="可选，填写状态流转说明">
          <button id="task-transition-btn" type="button" style="margin-top:10px;">更新任务状态</button>
        </div>
        <div>
          <h4>派发任务</h4>
          <label>任务 ID</label>
          <input id="task-dispatch-id" placeholder="可从上方列表自动带入">
          <label style="margin-top:8px;">处理人用户 ID</label>
          <input id="task-dispatch-user" placeholder="请输入处理人用户 ID">
          <label style="margin-top:8px;">说明</label>
          <input id="task-dispatch-note" placeholder="可选，填写派发说明">
          <button id="task-dispatch-btn" type="button" style="margin-top:10px;">派发任务</button>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:12px;">
        <div>
          <h4>提交审批</h4>
          <label>任务 ID</label>
          <input id="task-submit-approval-id" placeholder="可从上方列表自动带入">
          <label style="margin-top:8px;">说明</label>
          <input id="task-submit-approval-note" placeholder="可选，填写提交说明">
          <button id="task-submit-approval-btn" type="button" style="margin-top:10px;">提交审批</button>
        </div>
        <div>
          <h4>审批决定</h4>
          <label>任务 ID</label>
          <input id="task-approve-id" placeholder="可从上方列表自动带入">
          <label style="margin-top:8px;">审批结果</label>
          <select id="task-approve-decision" {% if not can_task_approve %}disabled{% endif %}>
            <option value="APPROVE">APPROVE</option>
            <option value="REJECT">REJECT</option>
          </select>
          <label style="margin-top:8px;">说明</label>
          <input id="task-approve-note" placeholder="可选，填写审批说明" {% if not can_task_approve %}disabled{% endif %}>
          <button id="task-approve-btn" type="button" style="margin-top:10px;" {% if not can_task_approve %}disabled{% endif %}>应用审批结果</button>
          {% if not can_task_approve %}
          <p class="hint">当前账号缺少 `mission.approve` 权限，审批按钮已禁用。</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="action-cluster">
      <h3>创建任务</h3>
      <p>常用的新建入口保留在这里，复杂批量操作折叠到下方高级区域。</p>
      <div class="grid cols-2">
        <div>
          <label>任务类型</label>
          <select id="task-create-type">
            {% for item in task_types %}
            <option value="{{ item.id }}">{{ item.name }} ({{ item.code }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>模板（可选）</label>
          <select id="task-create-template">
            <option value="">不使用模板</option>
            {% for item in templates %}
            <option value="{{ item.id }}">{{ item.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>任务名称</label>
          <input id="task-create-name" placeholder="请输入任务名称">
        </div>
        <div class="grid cols-2">
          <div>
            <label>优先级</label>
            <input id="task-create-priority" type="number" min="1" max="10" value="5">
          </div>
          <div>
            <label>风险等级</label>
            <input id="task-create-risk" type="number" min="1" max="5" value="3">
          </div>
        </div>
      </div>
      <button id="task-create-btn" type="button" style="margin-top:10px;">创建任务</button>
    </div>

    <details class="details-shell">
      <summary>更多操作：评论、批量创建与历史查看</summary>
      <div class="details-shell-body">
        <div class="grid cols-2" style="margin-top:12px;">
          <div>
            <h4>添加评论</h4>
            <label>任务 ID</label>
            <input id="task-comment-id" placeholder="可从上方列表自动带入">
            <label style="margin-top:8px;">评论内容</label>
            <input id="task-comment-content" placeholder="请输入评论内容">
            <button id="task-comment-btn" type="button" style="margin-top:10px;">添加评论</button>
          </div>
          <div>
            <h4>批量创建任务</h4>
            <label>任务类型</label>
            <select id="task-batch-type">
              {% for item in task_types %}
              <option value="{{ item.id }}">{{ item.name }} ({{ item.code }})</option>
              {% endfor %}
            </select>
            <label style="margin-top:8px;">模板（可选）</label>
            <select id="task-batch-template">
              <option value="">不使用模板</option>
              {% for item in templates %}
              <option value="{{ item.id }}">{{ item.name }}</option>
              {% endfor %}
            </select>
            <label style="margin-top:8px;">任务名称（每行一个）</label>
            <textarea id="task-batch-names" rows="4" placeholder="任务 A&#10;任务 B"></textarea>
            <button id="task-batch-create-btn" type="button" style="margin-top:10px;">批量创建</button>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:12px;">
          <div>
            <h4>查看评论</h4>
            <label>任务 ID</label>
            <input id="task-comments-id" placeholder="可从上方列表自动带入">
            <button id="task-comments-load-btn" type="button" style="margin-top:10px;">加载评论</button>
            <pre id="task-comments-box" class="hint" style="white-space:pre-wrap; margin-top:8px;">尚未加载评论。</pre>
          </div>
          <div>
            <h4>查看历史</h4>
            <label>任务 ID</label>
            <input id="task-history-id" placeholder="可从上方列表自动带入">
            <button id="task-history-load-btn" type="button" style="margin-top:10px;">加载历史</button>
            <pre id="task-history-box" class="hint" style="white-space:pre-wrap; margin-top:8px;">尚未加载历史。</pre>
          </div>
        </div>
      </div>
    </details>
  </div>

</div>
{% endif %}

<div class="hint action-result" id="task-center-result" role="status" aria-live="polite"></div>

<div class="panel">
  <h2>任务模板</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>模板 ID</th>
          <th>模板名称</th>
          <th>任务类型</th>
          <th>默认优先级</th>
          <th>需审批</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in templates %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.name }}</td>
          <td>{{ item.task_type_id }}</td>
          <td>{{ item.default_priority }}</td>
          <td>{{ item.requires_approval }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2>任务类型</h2>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>类型 ID</th>
          <th>编码</th>
          <th>名称</th>
          <th>启用</th>
        </tr>
      </thead>
      <tbody>
        {% for item in task_types %}
        <tr>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.code }}</td>
          <td>{{ item.name }}</td>
          <td>{{ item.is_active }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/task_center_ui.js"></script>
{% endblock %}
