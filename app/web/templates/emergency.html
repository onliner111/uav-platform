{% extends "console_base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
{% endblock %}

{% block content %}
{% set linked_task_count = incidents | selectattr("linked_task_id") | list | length %}
{% set pending_incident_count = incidents | rejectattr("status", "equalto", "CLOSED") | list | length %}
<div class="cards ui-kpi-grid">
  <div class="card ui-kpi-card">
    <div>事件总数</div>
    <div class="value">{{ incidents|length }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>待处置事件</div>
    <div class="value">{{ pending_incident_count }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>已联动任务</div>
    <div class="value">{{ linked_task_count }}</div>
  </div>
  <div class="card ui-kpi-card">
    <div>写入权限</div>
    <div class="value">{{ "已开启" if can_incident_write else "只读" }}</div>
  </div>
</div>

<div class="panel">
  <div class="ui-section-head">
    <div>
      <h2>应急事件处置</h2>
      <p class="page-note">按向导完成选点、建单和任务联动，避免业务人员直接面对散乱操作。</p>
    </div>
  </div>
  <div class="wizard-shell">
    <div class="wizard-summary-card">
      <strong id="incident-wizard-status">第 1 步：确定事件位置</strong>
      <div id="incident-wizard-summary" class="hint">先在地图上确认位置，再继续创建事件单。</div>
      <div id="incident-wizard-error" class="hint" hidden></div>
    </div>
    <ol class="wizard-step-list" id="incident-wizard-steps">
      <li class="wizard-step-item active" data-step="1">1. 地图选点</li>
      <li class="wizard-step-item" data-step="2">2. 创建事件</li>
      <li class="wizard-step-item" data-step="3">3. 联动任务</li>
    </ol>

    <div class="selection-banner" id="incident-selection-banner">
      <strong>当前事件：</strong>尚未选中事件，可先新建事件或从下方列表选择。
    </div>
    <div class="selection-banner stack-gap-sm" id="incident-location-banner">
      <strong>当前坐标：</strong><span id="incident-location-text">默认坐标已加载，可点击地图重新选择。</span>
    </div>

    <section class="wizard-panel" data-step-panel="1">
      <h3>第 1 步：确定事件位置</h3>
      <p class="hint">点击地图选择现场位置。坐标确定后再继续建单，减少错位派发。</p>
      <div id="map" class="map-stage stack-gap-md"></div>
      <div class="wizard-actions">
        <button id="incident-step1-next" type="button">下一步：填写事件信息</button>
      </div>
    </section>

    <section class="wizard-panel" data-step-panel="2" hidden>
      <h3>第 2 步：创建事件</h3>
      <p class="hint">补充事件标题和等级，系统会自动使用当前地图坐标建单。</p>
      <div id="incident-level-guidance" class="selection-banner">
        <strong>风险提示：</strong>高等级事件会优先走快速联动链路，请确认等级选择准确。
      </div>
      <div class="action-cluster primary">
        <label>事件标题</label>
        <input id="incident-title" value="城区火情处置">
        <label class="stack-gap-sm">事件等级</label>
        <select id="incident-level">
          <option value="HIGH">高</option>
          <option value="MEDIUM">中</option>
          <option value="LOW">低</option>
        </select>
        {% if can_incident_write %}
        <button id="create-incident-btn" type="button" class="stack-gap-sm">创建应急事件</button>
        {% else %}
        <p class="hint">当前账号缺少 <code>incident.write</code>，无法创建事件。</p>
        {% endif %}
      </div>
      <div class="wizard-actions">
        <button id="incident-step2-prev" type="button" class="button-secondary">上一步</button>
        <button id="incident-step2-next" type="button">下一步：联动任务</button>
      </div>
    </section>

    <section class="wizard-panel" data-step-panel="3" hidden>
      <h3>第 3 步：联动任务</h3>
      <p class="hint">基于当前事件继续联动巡检任务，无需手动填写事件 ID。</p>
      <div id="incident-wizard-confirm" class="selection-banner">
        当前尚未创建或选中事件。
      </div>
      <div id="incident-task-suggestion" class="hint">系统会根据事件标题自动建议一个默认任务名称。</div>
      <section class="action-cluster primary">
        <label>任务名称（可选）</label>
        <input id="incident-task-name" placeholder="例如：应急巡查任务">
        <details class="details-shell stack-gap-sm">
          <summary>高级配置</summary>
          <div class="details-shell-body">
            <label>巡检模板 ID（可选）</label>
            <input id="incident-template-id" placeholder="如需指定模板可填写">
            <p class="hint">常规处置可直接使用默认模板，无需填写。</p>
          </div>
        </details>
        {% if can_incident_write %}
        <button id="create-task-btn" type="button" class="stack-gap-sm">为当前事件一键建任务</button>
        {% endif %}
      </section>
      <div class="wizard-actions">
        <button id="incident-step3-prev" type="button" class="button-secondary">上一步</button>
      </div>
    </section>
  </div>
  <div class="hint action-result" id="emergency-result" role="status" aria-live="polite"></div>
</div>

<div class="panel">
  <div class="ui-section-head">
    <h2>近期事件</h2>
    <div class="ui-action-row">
      <a class="console-link" href="/ui/command-center">前往指挥中心</a>
      <a class="console-link" href="/ui/task-center">前往任务中心</a>
      <a class="console-link" href="/ui/inspection">前往巡检任务</a>
    </div>
  </div>
  <div class="table-scroll">
    <table>
      <thead>
        <tr><th>选择</th><th>ID</th><th>标题</th><th>等级</th><th>状态</th><th>关联任务</th><th>联动动作</th></tr>
      </thead>
      <tbody>
        {% if not incidents %}
        <tr>
          <td colspan="7" class="empty-state">当前暂无应急事件，可先在地图选点后创建。</td>
        </tr>
        {% endif %}
        {% for item in incidents %}
        <tr>
          <td>
            <button
              type="button"
              class="table-select js-incident-select"
              data-incident-id="{{ item.id }}"
              data-incident-title="{{ item.title }}"
              data-incident-status="{{ item.status }}"
              data-has-task="{{ 'true' if item.linked_task_id else 'false' }}"
            >
              选中
            </button>
          </td>
          <td><code>{{ item.id }}</code></td>
          <td>{{ item.title }}</td>
          <td>{{ item.level }}</td>
          <td>{{ item.status }}</td>
          <td>
            {% if item.linked_task_id %}
            <a class="console-link" href="/ui/task-center">{{ item.linked_task_id }}</a>
            {% else %}
            -
            {% endif %}
          </td>
          <td>
            {% if can_incident_write %}
            <button
              type="button"
              class="js-incident-create-task"
              data-incident-id="{{ item.id }}"
              data-incident-title="{{ item.title }}"
              {% if item.linked_task_id %}disabled{% endif %}
            >
              {% if item.linked_task_id %}已创建任务{% else %}立即联动任务{% endif %}
            </button>
            {% else %}
            <span class="hint">只读</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.__CAN_INCIDENT_WRITE = {{ can_incident_write | tojson }};
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/emergency.js"></script>
{% endblock %}
