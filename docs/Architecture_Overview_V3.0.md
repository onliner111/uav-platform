# 城市低空综合治理与应急指挥平台
# 系统架构说明书（V3.0）

- 文档版本：V3.0
- 架构范围：`phase-01` 至 `phase-39` 已实现能力；`phase-40` 至 `phase-43` 已完成规划但尚未执行
- 更新日期：2026-03-02

## 0. 建议谁看这份文档

适合阅读：

- 产品经理
- 项目经理
- 交付工程师
- 技术负责人
- 平台管理员（需要理解边界时）

不建议作为首选文档的读者：

- 普通业务用户
- 只需要日常操作的值守 / 调度 / 现场执行人员

阅读建议：

1. 先看 [文档导航_V3.0.md](./文档导航_V3.0.md) 选择对应文档入口
2. 需要接口细节时，再配合 [API_Appendix_V3.0.md](./API_Appendix_V3.0.md) 一起阅读

---

## 1. 架构目标与约束

### 1.1 目标

1. 支撑巡查、应急、指挥、合规、评估的一体化低空治理闭环
2. 保证多租户隔离、数据可追溯、关键动作可审计
3. 支撑 AI 辅助分析与开放平台对接，同时保持控制决策可解释
4. 面向非技术业务人员长期使用，提供角色化、向导化、可交付的控制台体验

### 1.2 约束

1. 单体架构（Monolith），禁止提前微服务拆分
2. 前端采用 Jinja2 + 静态 JS，无独立前端构建流水线
3. 容器化运行，统一通过 Docker Compose
4. AI 能力只提供分析建议，不直接执行控制动作
5. 已实现产品化 UI，但真实无人机、机巢/机场、视频工程化仍在后续规划阶段

---

## 2. 总体架构

```text
                 +-----------------------------+
                 |        Browser / API Client |
                 +--------------+--------------+
                                |
                                v
                     +----------+-----------+
                     |      FastAPI App     |
                     |  (Monolith, app/)    |
                     +----+-----+-----+-----+
                          |     |     |
                          |     |     +--------------------+
                          |     |                          |
                          v     v                          v
                    +-----+--+  +----------------+   +-----+------+
                    | Redis  |  | PostgreSQL     |   | Static UI  |
                    | state  |  | (PostGIS image)|   | Jinja2/JS  |
                    +--------+  +----------------+   +------------+
```

---

## 3. 分层设计

代码目录按职责分层：

1. `app/api`：HTTP/WS 入口、鉴权、路由编排
2. `app/services`：业务用例、流程与规则编排
3. `app/domain`：领域模型、状态机、权限与策略常量
4. `app/infra`：数据库、审计中间件、事件总线、OpenAPI 导出
5. `app/adapters`：外部系统适配器（无人机厂商、开放平台）
6. `app/web`：Jinja2 页面与静态资源

---

## 4. 核心模块

### 4.1 身份、组织与数据边界（Identity/RBAC）

- 租户、用户、角色、权限、组织节点、模板角色
- 用户角色批量绑定、数据边界策略、租户级访问控制
- JWT 鉴权、权限守卫 `require_perm(...)`

### 4.2 飞行执行主链路（Registry/Mission/Telemetry/Command）

- 设备注册与状态管理（`/api/registry`）
- 任务编排与执行（`/api/mission`）
- 遥测采集与实时推送（`/api/telemetry` + WS）
- 指令下发与审计（`/api/command`）

### 4.3 资产与维护（Assets）

- 资产台账、区域资源池、可用性健康评分
- 维护工单、维护历史、维护统计（`/api/assets/maintenance`）
- 支撑任务派发前资源充足性判断

### 4.4 空域合规与任务中心（Compliance/Map/Task-Center）

- 空域规则校验与飞前合规清单（`/api/compliance`）
- 一张图态势聚合、图层、轨迹回放（`/api/map`）
- 统一任务中心：分派、风险评分、协同批注、生命周期（`/api/task-center`）
- 一张图已演进到值守 / 领导 / 演示多模式，并补齐事件时间轴与焦点对象联动

### 4.5 巡查与问题闭环（Inspection/Defect/Incident）

- 巡查模板、任务、观测点（`/api/inspection`）
- 问题单生成、流转、复核、关闭（`/api/defects`）
- 事件创建与应急链路（`/api/incidents`）

### 4.6 成果、告警与报表（Outcomes/Alert/Reporting）

- 成果目录、成果状态机、处理链路（`/api/outcomes`）
- 告警优先级、路由与处置联动（`/api/alert`）
- 报表导出与统计（`/api/reporting`）
- 产品层已演进为“通知协同中心”和“业务闭环与汇报”

### 4.7 AI 助手与证据链（AI）

- 分析作业、运行、输出、证据、复核动作全链路
- 建议可解释、可追溯，不允许直接控制执行（`control_allowed=false`）
- 接口前缀：`/api/ai`

### 4.8 KPI 与开放平台（KPI/Open-Platform）

- KPI 快照、趋势与热力聚合（`/api/kpi`）
- 开放平台凭据、签名、Webhook、适配器治理（`/api/open-platform`）
- 对外集成在租户边界内可审计运行

### 4.9 真实接入与运行保障（Integration/Observability/Platform Ops）

- 设备接入会话与视频流管理（`/api/integration`）
- 可观测性、SLO、备份演练、安全巡检与容量策略
- 平台页已演进为“上线保障与版本运营台”，覆盖开通、培训、上线检查、发布说明与灰度启用
- 当前真实接入为“可扩展基线”，真实无人机、机巢/机场、视频工程化将在 Phase 40-43 继续深化

### 4.10 治理与运维扩展接口

- 审批与审计：`/api/approvals`
- Dashboard 聚合与 WS：`/api/dashboard`、`/ws/dashboard`
- 租户导出与租户清理：`/api/tenant-export`、`/api/tenant-purge`

---

## 5. 数据架构

### 5.1 多租户隔离

所有核心业务表包含 `tenant_id`，查询默认按租户隔离；跨租户访问通过显式权限与审计约束。

### 5.2 核心实体（节选）

1. 身份与组织：`tenants/users/roles/permissions/org_units`
2. 任务执行：`missions/telemetry_points/command_logs`
3. 资产维护：`assets/asset_maintenance_orders/asset_maintenance_records`
4. 合规与任务中心：`compliance_rules/task_center_*`
5. 成果与告警：`outcomes/outcome_actions/alerts/alert_actions`
6. AI 与证据：`ai_jobs/ai_runs/ai_outputs/ai_evidences/ai_review_actions`
7. KPI 与开放平台：`kpi_snapshots/open_platform_credentials/open_platform_webhooks`
8. 审批与审计：`approval_records/audit_logs/events`

---

## 6. 关键流程时序

### 6.1 巡查与闭环流程

```text
模板创建 -> 巡查任务 -> 观测点 -> 问题单 -> 处理/复核 -> 关闭 -> 报表
```

### 6.2 合规与执行流程

```text
任务创建 -> 空域/清单校验 -> 资源匹配 -> 指令下发 -> 遥测回传 -> 态势展示
```

### 6.3 AI 证据链流程

```text
分析请求 -> 任务运行 -> 证据聚合 -> 生成建议 -> 人工复核 -> 结果归档
```

### 6.4 KPI 与开放平台流程

```text
业务数据汇总 -> KPI 聚合 -> 对外签名推送/拉取 -> 适配器记录审计
```

---

## 7. 事件与审计机制

### 7.1 事件机制

- 关键状态变更通过 `event_bus` 发布到 `events` 表
- 用于追踪任务、审批、告警、AI 复核、开放平台交互等生命周期

### 7.2 审计机制

- `AuditMiddleware` 对关键请求记录审计日志
- 审计字段包括：租户、操作人、动作、资源、方法、状态码、时间、上下文

---

## 8. 实时能力设计

### 8.1 遥测通道

- 遥测状态写入 Redis 最新值
- 提供 WebSocket 推送实时数据

### 8.2 指挥中心通道

- `WS /ws/dashboard` 周期推送统计与地图态势
- 前端按增量数据刷新图层与关键指标

### 8.3 设备接入与视频通道

- 设备接入通过适配器模式统一接入 `FAKE / MAVLINK / DJI`
- 当前已具备真机接入骨架与仿真兜底
- 视频流支持配置、状态展示与一张图联动，媒体工程化能力仍处于后续规划阶段

---

## 9. 部署架构

部署单元：

1. `app`：主业务服务
2. `db`：PostgreSQL（PostGIS）
3. `redis`：状态缓存
4. `app-tools`：脚本执行与验证

编排方式：

- `infra/docker-compose.yml`
- `Makefile` 封装 lint/typecheck/test/e2e 常用命令

---

## 10. 安全设计

1. JWT 身份认证
2. 细粒度权限控制（接口级）
3. 多租户数据隔离与跨租户防护
4. 关键行为审计
5. 对外接口签名校验与凭据治理

---

## 11. 可扩展性设计

### 11.1 适配器扩展

新增外部系统接入时，在 `app/adapters` 增加实现并在服务层注册，无需拆分服务。

适用对象包括：

- 无人机厂商接入
- 机巢 / 机场设施接入
- 视频链路接入
- 外部业务系统与开放平台

### 11.2 业务扩展

新增业务优先遵循：

1. 增加领域模型与迁移
2. 增加服务层用例
3. 增加 API 路由与权限
4. 增加审计、事件与测试覆盖

---

## 12. 已知限制与演进建议

已知限制：

1. 几何字段仍以简化结构为主，复杂空间计算能力有限
2. Dashboard 推送以周期刷新为主，事件驱动聚合仍可增强
3. 导出文件默认落地本地文件系统，依赖外部归档策略
4. 真实无人机接入当前是“基线能力”，MAVLink 有真实链路骨架，DJI 仍以仿真兜底为主
5. 机巢 / 机场当前主要停留在资产台账与管理层，尚未形成完整控制链路
6. 视频链路已具备接入抽象与状态展示，但尚未建设完整媒体工程体系

演进建议：

1. 引入对象存储与生命周期治理
2. 增加系统级 SLA 与告警指标（延迟、吞吐、错误率）
3. 在业务规模增长后评估异步任务队列与分层拆分
4. 按已规划的 Phase 40-43 推进真实无人机、机巢 / 机场、视频链路与现场试点验证

---

## 13. 接口清单附录

详细接口请参见 `docs/API_Appendix_V3.0.md`。

架构模块与接口边界以附录为准，作为联调和验收基线。
